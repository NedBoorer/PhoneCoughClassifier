# Fly.io Quick Reference

Quick commands for managing your Phone Cough Classifier on Fly.io.

## Initial Setup

```bash
# Install Fly CLI
curl -L https://fly.io/install.sh | sh

# Login
fly auth login

# Create app
fly apps create phone-cough-classifier

# Create volume (1GB storage)
fly volumes create cough_data --size 1 --region sjc
```

## Deployment

```bash
# Deploy
fly deploy

# Deploy with local build (faster)
fly deploy --local-only

# Deploy without cache (clean build)
fly deploy --no-cache

# Deploy using script
./scripts/deploy_flyio.sh
```

## Secrets Management

```bash
# Set secrets
fly secrets set TWILIO_ACCOUNT_SID="AC..."
fly secrets set TWILIO_AUTH_TOKEN="..."
fly secrets set TWILIO_PHONE_NUMBER="+1234567890"
fly secrets set BASE_URL="https://your-app.fly.dev"
fly secrets set OPENAI_API_KEY="sk-..."

# List secrets (names only, not values)
fly secrets list

# Remove secret
fly secrets unset KEY_NAME

# Set multiple secrets from file
fly secrets import < secrets.txt
```

## Monitoring

```bash
# View logs (live tail)
fly logs

# Recent logs only
fly logs --lines 100

# Filter by severity
fly logs --filter ERROR

# App status
fly status

# Open web dashboard
fly dashboard

# Open app in browser
fly open

# Check health endpoint
fly open /health
```

## Scaling

```bash
# Scale instances
fly scale count 2          # Run 2 VMs
fly scale count 1          # Back to 1 VM

# Scale memory
fly scale memory 512       # 512MB RAM
fly scale memory 1024      # 1GB RAM
fly scale memory 2048      # 2GB RAM

# Change VM type
fly scale vm shared-cpu-1x
fly scale vm shared-cpu-2x

# View current scale
fly scale show
```

## Volume Management

```bash
# List volumes
fly volumes list

# Expand volume
fly volumes extend cough_data --size 5  # Expand to 5GB

# Create snapshot (backup)
fly volumes snapshots create cough_data

# List snapshots
fly volumes snapshots list

# Delete volume (careful!)
fly volumes delete VOLUME_ID
```

## SSH & Debugging

```bash
# SSH into machine
fly ssh console

# Run single command
fly ssh console -C "ls -la /app/data"

# SFTP access
fly ssh sftp shell

# Download file
fly ssh sftp get /app/data/cough_classifier.db ./backup.db

# Upload file
fly ssh sftp put ./models/new_model.joblib /app/models/

# Proxy local port to app
fly proxy 8000:8000
```

## Database Operations

```bash
# SSH and check database
fly ssh console -C "sqlite3 /app/data/cough_classifier.db 'SELECT COUNT(*) FROM health_assessments;'"

# Backup database
fly ssh console -C "sqlite3 /app/data/cough_classifier.db '.backup /app/data/backup.db'"

# Download backup
fly ssh sftp get /app/data/backup.db ./local-backup.db

# View database tables
fly ssh console -C "sqlite3 /app/data/cough_classifier.db '.tables'"
```

## Releases & Rollback

```bash
# List releases
fly releases

# Rollback to previous version
fly releases rollback

# Rollback to specific version
fly releases rollback v5
```

## App Management

```bash
# List all your apps
fly apps list

# App info
fly apps info phone-cough-classifier

# Restart app
fly apps restart

# Destroy app (careful!)
fly apps destroy phone-cough-classifier
```

## Regions

```bash
# List available regions
fly platform regions

# Add region
fly regions add lhr  # London

# Remove region
fly regions remove lhr

# List app's regions
fly regions list
```

## Certificates (Custom Domains)

```bash
# Add custom domain
fly certs add yourdomain.com

# List certificates
fly certs list

# Check certificate status
fly certs show yourdomain.com

# Remove certificate
fly certs remove yourdomain.com
```

## Troubleshooting

```bash
# Check if app is responding
curl https://your-app.fly.dev/health

# View machine status
fly vm status

# Check metrics
fly status

# Restart unhealthy machine
fly apps restart

# Force redeploy (same code)
fly deploy --strategy immediate

# Check build logs
fly logs --filter build
```

## Configuration

```bash
# View current config
cat fly.toml

# Validate fly.toml
fly config validate

# View app's env vars (not secrets)
fly ssh console -C "env | grep -E 'ENVIRONMENT|DEBUG|PORT'"
```

## Cost Management

```bash
# View billing
fly billing

# Check resource usage
fly status

# Stop app (scale to 0)
fly scale count 0

# Start app
fly scale count 1

# Auto-scale to 0 when idle (already in fly.toml)
# min_machines_running = 0
```

## Useful Checks

```bash
# Is app deployed?
fly status

# Is app healthy?
curl https://your-app.fly.dev/health

# Are secrets set?
fly secrets list

# Is volume mounted?
fly ssh console -C "df -h /app/data"

# What version is running?
fly releases --limit 1

# How much data in volume?
fly ssh console -C "du -sh /app/data"
```

## Emergency Commands

```bash
# App not responding - restart
fly apps restart

# High memory usage - scale up
fly scale memory 2048

# Rollback bad deployment
fly releases rollback

# View error logs
fly logs --filter ERROR --lines 100

# Check if machine is running
fly vm status

# Force stop and start
fly scale count 0 && fly scale count 1
```

## Your App URLs

Replace `phone-cough-classifier` with your app name:

```
App URL:       https://phone-cough-classifier.fly.dev
API Docs:      https://phone-cough-classifier.fly.dev/docs
Health Check:  https://phone-cough-classifier.fly.dev/health
Dashboard:     https://fly.io/apps/phone-cough-classifier
Metrics:       https://fly.io/apps/phone-cough-classifier/metrics
```

## Twilio Webhook URLs

Configure in Twilio Console:

```
Voice Webhook:     https://your-app.fly.dev/india/voice/router
SMS Webhook:       https://your-app.fly.dev/twilio/sms/incoming
WhatsApp Webhook:  https://your-app.fly.dev/whatsapp/incoming
```

---

Save this file for quick reference! ðŸ“‹
